var model=EQ.namespace("eQ.MetricChart");codemr.metricchart=function(c,t,e,l){var a={myMetricSpec:t,myMetricValues:e};metricToolTipId=c+"-tooltip",l&&(d3.select("#"+c).append("div").attr("id",metricToolTipId),metricToolTipId="#"+metricToolTipId,d3.select(metricToolTipId).classed("metric-chart-tooltip",!0),d3.select(metricToolTipId).classed("metric-chart-tooltip-hidden",!0)),model.BARWITHDIV=25,model.chartMargin={top:20,right:20,bottom:20,left:40},model.chartWidth=560-model.chartMargin.left-model.chartMargin.right,model.chartHeight=240-model.chartMargin.top-model.chartMargin.bottom;var r=d3.scale.ordinal().rangeRoundPoints([0,model.chartWidth]),o=d3.scale.linear().range([0,model.chartWidth]),n=d3.scale.linear().range([model.chartHeight,0]),i=["#007F24","#62BF18","#FFC800","#FF5B13","#E50000"],d=["Low","Low-medium","Medium-high","High","Very high"],s=d3.svg.axis().scale(r).orient("bottom"),m=d3.svg.axis().scale(d3.scale.linear().range([model.chartHeight,0])).orient("left");svg=d3.select("#"+c).append("svg").attr("width",model.chartWidth+model.chartMargin.left+model.chartMargin.right).attr("height",model.chartHeight+model.chartMargin.top+model.chartMargin.bottom).append("g").attr("transform","translate("+model.chartMargin.left+","+model.chartMargin.top+")"),nameElement=d3.select("#"+c).append("text").attr("class","default-text-color").html("");for(var h={},p=0;p<a.myMetricValues.length;++p)h[a.myMetricValues[p].name]=+a.myMetricValues[p].value;var u=[""];Array.prototype.push.apply(u,a.myMetricSpec.map(function(t){return t.shortname})),u.push(" "),r.domain(u),rectWidth=Math.floor(o.range()[1]/model.BARWITHDIV),rectHeight=Math.min(3,Math.floor(n.range()[0]/100)),rectCorner=rectHeight/2,yD=model.chartHeight-rectHeight-rectHeight;var g=[],y=[];for(p=0;p<a.myMetricSpec.length;++p){y.push({spec:a.myMetricSpec[p]}),n.domain([a.myMetricSpec[p].thresholds[0],a.myMetricSpec[p].thresholds[5]]);var M=[n(a.myMetricSpec[p].thresholds[1]),n(a.myMetricSpec[p].thresholds[2]),n(a.myMetricSpec[p].thresholds[3]),n(a.myMetricSpec[p].thresholds[4])];for(a.myMetricSpec[p].level=0;h[a.myMetricValues[p].name]>a.myMetricSpec[p].thresholds[a.myMetricSpec[p].level]&&a.myMetricSpec[p].level<a.myMetricSpec[p].thresholds.length;)a.myMetricSpec[p].level++;a.myMetricSpec[p].level=a.myMetricSpec[p].level-1;for(var f=0;0<yD;){for(;yD<M[f]&&f<M.length;)f++;g.push({metricLevel:f,posY:yD,spec:a.myMetricSpec[p]}),yD-=3*rectHeight}yD=model.chartHeight-rectHeight-rectHeight}svg.append("rect").attr("x",-model.chartMargin.left).attr("y",-model.chartMargin.top).attr("width","100%").attr("height","100%").attr("rx",5).attr("ry",5).attr("fill","black"),svg.append("g").attr("transform","translate("+model.chartMargin.left+","+model.chartMargin.top+")");var v=svg.append("g").attr("class","valuetextContainer");v.selectAll(".valuetext").data(a.myMetricSpec).enter().append("text").attr("class","valuetext").attr("x",function(t){return r(t.shortname)-rectWidth/2}).attr("y",-3).attr("text-anchor","middle").text(function(t){return h[t.name]}),svg.append("g").attr("class","scatrect").attr("class","x axis").attr("transform","translate(0,"+model.chartHeight+")").call(s).append("text").attr("class","label").attr("x",model.chartWidth).attr("y",-6).style("text-anchor","end").text("Metric"),svg.append("g").attr("class","y axis").call(m).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Metric Value");var x=svg.append("g").attr("class","fakeColumnContainer"),S=svg.append("g").attr("class","dotContainer");x.selectAll(".dot").data(g).enter().append("rect").attr("class","dot").attr("width",model.BARWITHDIV+6).attr("height",model.chartHeight-rectHeight).attr("stroke-width",0).attr("stroke-opacity",0).attr("fill-opacity",0).attr("x",function(t){return r(t.spec.shortname)-model.BARWITHDIV/2-3}).attr("y",0).on("mousemove",function(t){return H(t)}).on("mouseout",function(t){return I(t)}).style("fill",function(t){return"white"}),S.selectAll(".dot").data(g).enter().append("rect").attr("class","dot").attr("width",rectWidth).attr("height",rectHeight).attr("stroke-width",0).attr("stroke-opacity",1).attr("rx",rectCorner).attr("ry",rectCorner).attr("x",function(t){return r(t.spec.shortname)-rectWidth/2}).attr("y",function(t){return t.posY}).attr("opacity",function(t){return n.domain([t.spec.thresholds[0],t.spec.thresholds[5]]),n(h[t.spec.name])>t.posY?.2:1}).on("mousemove",function(t){return H(t)}).on("mouseout",function(t){return I(t)}).style("fill",function(t){return i[t.metricLevel]});var T=svg.selectAll(".legend").data(d).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+20*(5-e)+")"});T.append("rect").attr("x",model.chartWidth-18).attr("width",18).attr("height",9).attr("rx",2*rectCorner).attr("ry",2*rectCorner).style("fill",function(t,e){return i[e]}),T.append("text").attr("x",model.chartWidth-24).attr("y",9).style("text-anchor","end").text(function(t){return t});var H=function(t){if(l){var e=d3.event.pageX,r=d3.event.pageY;elem=document.getElementById(c),boundingRect=elem.getBoundingClientRect();var a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;d3.event.pageX>boundingRect.left+boundingRect.width/2?(d3.select(metricToolTipId).style("right",a-e+"px"),d3.select(metricToolTipId).style("left","auto")):(d3.select(metricToolTipId).style("left",e+"px"),d3.select(metricToolTipId).style("right","auto")),d3.select(metricToolTipId).style("top",r+"px"),d3.select(metricToolTipId).html("<strong>"+t.spec.name+":</strong> <span style='color:red'>"+h[t.spec.name]+"<br>("+d[t.spec.level]+")<br></span>"),d3.select(metricToolTipId).classed("metric-chart-tooltip-hidden",!1)}},I=function(t){l&&d3.select(metricToolTipId).classed("metric-chart-tooltip-hidden",!0)};return model.updateDotsFunctionMap||(model.updateDotsFunctionMap={}),model.updateDots||(model.updateDots=function(t,e){for(var r in model.updateDotsFunctionMap)model.updateDotsFunctionMap[r].updateMetricValues(t,e)}),metricChartManager={updateMetricValues:function(t,e){for(var r=0;r<t.length;++r)h[t[r].name]=+t[r].value;for(r=0;r<a.myMetricSpec.length;++r){for(a.myMetricSpec[r].level=0;h[a.myMetricValues[r].name]>a.myMetricSpec[r].thresholds[a.myMetricSpec[r].level]&&a.myMetricSpec[r].level<a.myMetricSpec[r].thresholds.length;)a.myMetricSpec[r].level++;a.myMetricSpec[r].level=a.myMetricSpec[r].level-1,5<=a.myMetricSpec[r].level&&(a.myMetricSpec[r].level=4),a.myMetricSpec[r].level<=0&&(a.myMetricSpec[r].level=0),e&&nameElement.html("<br>"+e)}S.selectAll(".dot").attr("opacity",function(t){return n.domain([t.spec.thresholds[0],t.spec.thresholds[5]]),n(h[t.spec.name])>t.posY?.2:1}),v.selectAll(".valuetext").text(function(t){return h[t.name]})}},model.updateDotsFunctionMap[c]=metricChartManager,model.handleMBCheckBox=function(t){t.checked?document.getElementById(c).style.display="inline":document.getElementById(c).style.display="none"},metricChartManager.setVisible=function(t){t?d3.select("#"+c).classed("metric-chart-hidden",!1):d3.select("#"+c).classed("metric-chart-hidden",!0)},metricChartManager.getWidth=function(){return 560},metricChartManager};
